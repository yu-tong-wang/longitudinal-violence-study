---
title: "Causal2 Project Part2: Simulation"
author: "Namita Trikannad"
date: "11/21/2019"
output: pdf_document
---

```{r setup, include=FALSE}
# set default knitr chunks
knitr::opts_chunk$set(
  tidy.opts=list(width.cutoff=60),tidy=TRUE,
  echo = FALSE,  # don't print the code chunk
  results = 'hide',
  warning = FALSE,  # don't print warnings
  message = FALSE,  # don't print messages
  fig.width = 6,  # set default width of figures
  fig.height = 4,  # set default height of figures
  fig.align = "center",  # always align figure in center
  fig.pos = "H",  # always plot figure at the exact location of the code chunk
  cache = T)  # don't cache results  #CHANGE THIS TO "FALSE" AFTER YOU'RE DONE !!

library(tidyverse)
library(data.table)
library(ltmle)
library(SuperLearner)
```

```{r, loadData}
load("data/female_SCM.RData")
```

```{r, exploreData}
skim(female_SCM)
str(female_SCM)
summary(female_SCM)
```

Explanation of variable names: 
1. `"CODENUM"`: Identification number 
2. `"cohort"`: Indicates the cohort to which the individual belongs (90 or 91)
3. `"victim"`: Binary indicating whether individual was victimized (1) or not (0) at time t 
4. `"suicide"`: Binary indicating suicide attempt or ideation was made (1) or not (0) at time t 
5. `"relation"`: Binary indicating whether in a relationship (1) or not (0) status at time t 
6. `"religious`: Binary indicating individual is religious (1) or not (0) at time t 
7. `"psystress"`: Continuous scale showing negative psychological stress (higher number indicates more stress)
8. `"psywell"`: Continuous scale showing psychological well being (higher number indicates well being)
9. `"victfrnd"`: Binary indicating whether (1) or not (0) the victim knew other women who were sexually victimized 
10. `"drug"`: Binary indicating drug use (1) or not (0) at time t 
11. `"alcohol"`: Binary indicating alcohol (yes for 1 and no for 0) use at time t 
12. `"race", "sxorient", "consent", "forced", "forced_att", "sex_bef14"`: All baseline covariates

```{r, toBinary}
cols <-  which(sapply(female_SCM, is.logical))
setDT(female_SCM)
for(j in cols){
 set(female_SCM, i=NULL, j=j, value= as.numeric(female_SCM[[j]]))
}

save(female_SCM, file = "data/female_SCM.RData")
```

```{r}
colSums(is.na(female_SCM))
```

Simulation: See also “For Your Project” questions from R lab 1. 
i.	Describe your simulation: We have the the following types of variables in our data and they were simulated as follows: 
*Binary variables in the data:* All of the below variables were generated as binomial random variables with `p` as the mean of this variable in the observed data 
A(t) : Victimization
L1 (t) : Suicidal tendency or ideation observed (binary)
L2 (t) : Relationship status 
L3 (t) : Religious status
L4 (t) : Whether the victim knew other women who were victimized 
L5 (t) : Drug use 
L6 (t) : Alcohol use 

*Continuous variables in the data:* The following two variables show somewhat normal distribution and thefore were generated as normal distribution with mean and variance as that of the original data. 
L7 (t) : Psychological stress on a scale (higher value indicates higher stress)
L8 (t) : Psychological well being on a scale (higher value indicates well being)
```{r}

#Example for psywell1
p1 <- ggplot(female_SCM) + 
  geom_histogram(aes(x = psywell1), color = "black", alpha = "0.5") +
  labs(title = "psywell: psychological well being score") +
  theme(plot.title = element_text(size =10, hjust = 0.5))

#Example of psystress1
p2 <- ggplot(female_SCM) + 
  geom_histogram(aes(x = psystress4), color = "black", alpha = 0.5) +
  labs (title = "psystress: psychological stress score") +
  theme(plot.title = element_text(size =10, hjust = 0.5))


ggarrange(p1,p2) %>%
  annotate_figure(top = "Distribution of continuous variables")

```

*Discrete variable:*
Y : Outcome, which is accrued number of times suicidal tendency or ideation was recorded at the end of the study (Sum of L1(t) at each t = 1,2,3,4)

ii.	Provide preliminary results of applying your estimator(s) to your simulated data: 

Generate data 
```{r}
#Use n = 1580 to match the observed data

n = 1580
t = 4

generate_data <- function(n,t) {
  
 df <- data.frame( # Intervention node:
                   A = rbinom(n, 1, prob = 0.4), 
                   # Suicidal tendency 
                   L1 =  rbinom(n, 1, prob = 0.07),
                   # Relationship status, binary with mean 0.25
                   L2 =  rbinom(n, 1, prob = 0.25),
                   # Religious status, binary with mean 0.25
                   L3 = rbinom(n, 1, prob = 0.71),
                   # Victfriend, binary with mean 0.59
                   L4 =  rbinom(n, 1, prob = 0.59),
                   # Drug use 
                   L5 = rbinom(n, 1, prob = 0.25),
                   # Alcohol use
                   L6 = rbinom(n, 1, prob = 0.75),
                   # Dating 
                   L7 = rbinom(n, 1, prob = 0.80),
                   # Psychological stress
                   L8 = rnorm(n, 2.15, 0.7),
                   # Psychological stress
                   L9 = rnorm(n, 3.24, 0.8))
 colnames(df) <- paste(colnames(df), c(t,t,t,t,t,t,t,t,t), sep = "_")
 
 return(df) 
 }
 
 df <- bind_cols(lapply(1:4, generate_data, n = 1580))
 
# Add outcome 
 df <- df %>%
    mutate(Y = L1_1 + L1_2 + L1_3 + L1_4) 
  
```

Implement tmle: 
```{r}
sl_lib <- c("SL.glm", "SL.mean")

# Time ordered intervention nodes 
Anodes <- c("A_1","A_2","A_3","A_4")

# Time ordered L nodes 
Lnodes <-  c("L1_1","L2_1","L3_1","L4_1", "L5_1", "L6_1", "L7_1", "L8_1", "L9_1",
            "L1_2","L2_2","L3_2","L4_2", "L5_2", "L6_2", "L7_2", "L8_2", "L9_2",
            "L1_3","L2_3","L3_3","L4_3", "L5_3", "L6_3", "L7_3", "L8_3", "L9_3",
            "L1_4","L2_4","L3_4","L4_4", "L5_4", "L6_4", "L7_4", "L8_4", "L9_4")

# Outcome Y
Ynodes <- "Y"

# Estimate without G-comp 
est <- ltmle(data = df,
             Anodes = Anodes, 
             Lnodes = Lnodes, 
             Ynodes = Ynodes,
             abar = list(c(1, 1, 1, 1), c(0, 0, 0, 0)),
             variance.method = "ic",
             gcomp = F,
             SL.library = sl_lib)

# Estimate with G-comp

est1 <- ltmle(data = df,
              Anodes = Anodes,
              Lnodes = Lnodes, 
              Ynodes = Ynodes,
              abar = list(c(1, 1, 1, 1), c(0, 0, 0, 0)),
              variance.method = "ic",
              gcomp = T,
              SL.library = sl_lib)


```

```{r}
summary(est, "tmle")
summary(est, "iptw")
summary(est1, "gcomp")
```

Preliminary results with 95% CI:
```{r}
data.frame(Estimators = c("TMLE", "IPTW", "G-COMP"), Estimate = c("-0.062524 ", "-0.085855 ","-0.027341" ), CI = c("[-0.1547, 0.029656]", "[-0.22868, 0.05697]", "[-0.119, 0.064316]"))
```


